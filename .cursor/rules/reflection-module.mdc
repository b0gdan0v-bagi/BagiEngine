---
description: Rules for Reflection and Serialization system
globs:
  - "**/Reflection/**/*"
  - "**/*Test*.h"
  - "**/*Test*.cpp"
alwaysApply: false
---

# Reflection System Guidelines

## Overview

Compile-time reflection with Python code generator (meta_generator). Auto-generates `Serialize()` methods.

## Macros

| Macro | Purpose |
|-------|---------|
| `BE_CLASS(Name)` | Reflection + auto `Serialize()` |
| `BE_CLASS(Name, FACTORY_BASE)` | Factory/enum generation for hierarchy |
| `BE_REFLECT_FIELD` | Mark field for serialization (same line!) |
| `BE_FUNCTION` | Mark method for reflection |

## Serialization

| Type | XML Format | Method |
|------|------------|--------|
| Primitives (int, bool, string, PoolString) | Attributes | `SerializeAttribute()` |
| Classes (BE_CLASS) | Child elements | `BeginObject()` + `Serialize()` |

```xml
<Player health="100" name="Hero">
    <Position x="10" y="20"/>
</Player>
```

## Usage

```cpp
// Class definition
struct Player {
    BE_CLASS(Player)
    BE_REFLECT_FIELD int32_t health = 100;  // âœ“ Same line
    BE_REFLECT_FIELD PoolString name;
    bool _internal = false;  // Not serialized
};

// Serialization
XmlArchive archive(XmlArchive::Mode::Write);
if (archive.BeginObject("Player")) {
    player.Serialize(archive);
    archive.EndObject();
}
```

## Factory Generation (FACTORY_BASE)

Use `BE_CLASS(Name, FACTORY_BASE)` on base class. Include `<Generated/EnumXxx.gen.hpp>`.

| Base Class | Enum | Factory |
|------------|------|---------|
| `ILogSink` | `LogSinkType` | `LogSinkFactory` |
| `IWidget` | `WidgetType` | `WidgetFactory` |

## Generated Methods

| Method | Description |
|--------|-------------|
| `GetStaticTypeName()` | Type name as `string_view` |
| `GetStaticTypeMeta()` | `ClassMeta&` for type |
| `Is<T>()` / `Cast<T>()` | Runtime type checking |
| `Serialize(Archive&)` | Auto-generated from `BE_REFLECT_FIELD` |

## Best Practices

- Put `BE_REFLECT_FIELD` on **same line** as field
- Include `.gen.hpp` in .cpp only
- Use `Is<T>()`/`Cast<T>()` instead of `dynamic_cast`
- Use `SerializeAttribute()` for primitives

## Don't

- Reflect pointers/references directly
- Put `BE_REFLECT_FIELD` on separate line
- Include `.gen.hpp` in headers
- Modify generated files
