---
description: Guidelines for Reflection and Serialization system
globs:
  - "**/Reflection/**/*"
  - "**/*Test*.h"
  - "**/*Test*.cpp"
alwaysApply: false
---

# Reflection System Guidelines

## Overview

BagiEngine uses a compile-time reflection system with Python-based code generation.
The system provides:
- `BE_CLASS(ClassName)` macro for class reflection
- `BE_REFLECT_FIELD` / `BE_REFLECT_ENUM` markers
- Auto-generated static methods and `ReflectionTraits<T>` specializations
- EnumUtils compatibility for reflected enums
- Abstract `IArchive` interface for serialization

## Marking Types for Reflection

### Macros

| Macro | Location | Purpose |
|-------|----------|---------|
| `BE_CLASS(Name)` | Inside class body | Declares static reflection methods |
| `BE_REFLECT_FIELD` | Before field declaration | Marks field for serialization |
| `BE_REFLECT_ENUM` | Before enum class | Enables EnumUtils compatibility |

### Usage Pattern

1. Add `BE_CLASS(ClassName)` inside struct/class body
2. Mark serializable fields with `BE_REFLECT_FIELD`
3. Include generated file in .cpp: `#include <Generated/FileName.gen.hpp>`

## Generated Static Methods

| Method | Description |
|--------|-------------|
| `GetStaticTypeName()` | Returns type name as `eastl::string_view` |
| `GetStaticFieldCount()` | Returns number of reflected fields |
| `ForEachFieldStatic(obj, func)` | Iterates over all fields with callback |

## Code Generation

### CMake Integration

Use `add_reflection_target()` in CMakeLists.txt to enable code generation.
Generated files are placed in `${CMAKE_BINARY_DIR}/Generated/`.

### Include Path

Include generated headers using angle brackets:
- `#include <Generated/MyFile.gen.hpp>`

## Serialization

### Available Archives

| Archive | Format | Use Case |
|---------|--------|----------|
| `XmlArchive` | XML (pugixml) | Human-readable saves, config files |
| `BinaryArchive` | Binary stream | Compact saves, network packets |

### Helper Functions

| Function | Description |
|----------|-------------|
| `ForEachField(obj, func)` | Iterate over all reflected fields |
| `FieldCount<T>()` | Get number of reflected fields |
| `HasReflection<T>` | Concept to check if type has reflection |
| `Serialize(archive, name, obj)` | Serialize/deserialize object |

## File Structure

| Path | Contents |
|------|----------|
| `BECore/Reflection/ReflectionMarkers.h` | `BE_CLASS`, `BE_REFLECT_*` macros |
| `BECore/Reflection/TypeTraits.h` | `ReflectionTraits<T>`, `FieldInfo` |
| `BECore/Reflection/IArchive.h` | Abstract archive interface |
| `BECore/Reflection/SaveSystem.h` | `Serialize<T>` function |
| `BECore/Reflection/XmlArchive.h` | XML implementation |
| `BECore/Reflection/BinaryArchive.h` | Binary implementation |
| `CI/reflector/reflector.py` | Code generator script |
| `CI/reflector/templates/` | Jinja2 templates |

## Key Points

- Use `eastl::string_view` for names (not `std::string_view`)
- Generated code is placed in build directory, excluded from source control
- Python parser uses regex patterns to find `BE_CLASS()` and `BE_REFLECT_FIELD`

## DO

- Use `BE_CLASS(ClassName)` inside class body
- Mark all serializable fields with `BE_REFLECT_FIELD`
- Use `PoolString` for frequently used strings
- Include generated headers in .cpp files
- Test serialization round-trips (write then read)
- Add headers to `add_reflection_target()` in CMakeLists.txt

## DON'T

- Don't reflect pointer types directly (use IDs or special handling)
- Don't reflect reference types
- Don't modify generated files (they are overwritten)
- Don't forget the `ClassName` argument in `BE_CLASS(ClassName)`
- Don't include generated headers in .h files (use forward declarations)
