---
description: Rules for TaskSystem module development
globs: src/Modules/TaskSystem/**/*
alwaysApply: false
---

# TaskSystem Module Guidelines

## Overview

C++20 coroutine-based asynchronous task execution system.

## Key Components

| Component | Purpose |
|-----------|---------|
| `Task<T>` | Main coroutine type with promise_type |
| `TaskHandle<T>` | Handle for tracking/cancelling tasks |
| `TaskManager` | Singleton API (`Run()`, `RunOnMainThread()`, `RunDelayed()`) |
| `ThreadPool` | Worker threads with work stealing |
| `TaskScheduler` | Priority queues, delayed tasks |
| `CancellationToken` | Cancellation support |
| `TaskGroup` | Group management for multiple tasks |

## Awaitables

| Awaitable | Purpose |
|-----------|---------|
| `SwitchToMainThread()` | Switch execution to main thread |
| `SwitchToBackground()` | Switch execution to background thread |
| `Delay(duration)` | Delay execution |
| `Yield()` | Yield to scheduler |

## Best Practices

### DO
- Use `co_await SwitchToMainThread()` before UI operations
- Use `CancellationToken` for long-running tasks
- Use `TaskGroup` to manage related tasks
- Use priority appropriately (Critical only for urgent work)
- Check `std::expected` from `GetResult()` (no-exceptions policy)

### DON'T
- Don't block main thread with `handle->Wait()`
- Don't create tasks in tight loops without yielding
- Don't ignore cancellation tokens
- Don't hold locks across `co_await`

## Thread Safety

- `TaskManager`, `ThreadPool`, `TaskScheduler` are thread-safe
- `Task<T>` is move-only, not thread-safe
- `TaskHandle<T>` methods are thread-safe
- `CancellationToken` is thread-safe

## Integration

TaskManager lifecycle integrated into CoreManager:
- `Initialize()` in `OnApplicationInit`
- `Update()` in `OnGameCycle`
- `Shutdown()` in `OnApplicationDeinit`
