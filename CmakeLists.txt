cmake_minimum_required(VERSION 3.31)
project(MySDLGame)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

set_property(GLOBAL PROPERTY USE_FOLDERS ON)

# CoreModule должен быть объявлен первым, так как другие модули используют его PCH
add_subdirectory(src/Modules/Core)
add_subdirectory(src/Modules/Math)
add_subdirectory(src/Modules/Events)
add_subdirectory(src/Modules/SDL)

file(GLOB_RECURSE SOURCES 
    "src/*.cpp" 
    "src/*.h"
    "src/*.cxx"
)

list(FILTER SOURCES EXCLUDE REGEX "src/Modules/.*")

add_executable(MyGame ${SOURCES})

source_group(TREE "${CMAKE_CURRENT_SOURCE_DIR}/src" PREFIX "Source Files" FILES ${SOURCES})

target_include_directories(MyGame PRIVATE 
    ${CMAKE_CURRENT_SOURCE_DIR}/src
)

# Настройка предкомпилированных заголовков для исполняемого файла
# REUSE_FROM позволяет переиспользовать PCH из CoreModule без перекомпиляции
target_precompile_headers(MyGame REUSE_FROM CoreModule)

# Для MSVC: автоматическое включение PCH через Force Include
# Это позволяет использовать PCH без явного #include в каждом файле
if(MSVC)
    # Получаем путь к PCH header относительно include directories
    # CoreModule добавляет ${PROJECT_ROOT}/src/Modules в include directories
    # PCH находится в src/Modules/Core/pch.h, поэтому путь будет Core/pch.h
    target_compile_options(MyGame PRIVATE /FI"Core/pch.h")
endif()

target_link_libraries(MyGame PRIVATE 
    CoreModule
    MathModule
    EventsModule
    SDLModule
)

# Копирование SDL3 DLL рядом с исполняемым файлом (для Windows, если используется SDL3-shared)
if(WIN32)
    if(TARGET ${CORESDL_SDL3_TARGET})
        # Проверяем, является ли таргет shared библиотекой
        get_target_property(SDL3_TYPE ${CORESDL_SDL3_TARGET} TYPE)
        if(SDL3_TYPE STREQUAL "SHARED_LIBRARY")
            add_custom_command(TARGET MyGame POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                $<TARGET_FILE:${CORESDL_SDL3_TARGET}>
                $<TARGET_FILE_DIR:MyGame>
            )
        endif()
    endif()
endif()

if(MSVC)
    set_property(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT MyGame)
endif()